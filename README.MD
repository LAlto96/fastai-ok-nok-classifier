# OK/NOK Image Classifier (fastai)

[![Python](https://img.shields.io/badge/Python-3.10%2B-blue.svg)](https://www.python.org/)
[![fastai](https://img.shields.io/badge/fastai-vision-success)](https://docs.fast.ai/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

Ce projet implÃ©mente un **classificateur binaire dâ€™images (OK / NOK)** basÃ© sur **fastai** et **PyTorch**, conÃ§u pour des scÃ©narios de **contrÃ´le qualitÃ©**, de **filtrage automatisÃ© dâ€™images**, ou de **prÃ©traitement visuel sÃ©curisÃ©**.

Il inclut lâ€™ensemble de la pipeline machine learning :

- prÃ©paration et nettoyage des datasets  
- constitution dâ€™un split train / validation / test  
- transfert dâ€™apprentissage avec ResNet18  
- analyse complÃ¨te des performances  
- optimisation du seuil de dÃ©cision (threshold tuning)  
- outils dâ€™infÃ©rence (prÃ©diction sur image individuelle)  
- export du modÃ¨le pour un usage en production

---

## ğŸ“‚ Structure du projet

```

.
â”œâ”€â”€ notebooks/
â”‚   â””â”€â”€ training.ipynb             # Notebook principal d'entraÃ®nement
â”œâ”€â”€ models/
â”‚   â””â”€â”€ ok_nok_resnet18_fastai.pkl # ModÃ¨le exportÃ©
â”œâ”€â”€ ok_nok_threshold.json          # Seuil optimal sÃ©lectionnÃ© (0.99)
â”œâ”€â”€ inference/
â”‚   â””â”€â”€ predict_image.py           # Script dâ€™infÃ©rence (optionnel)
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md

```

Les datasets bruts ne sont **pas versionnÃ©s** pour garder un dÃ©pÃ´t lÃ©ger.

---

## ğŸ“Š Objectif du modÃ¨le

Le modÃ¨le classe les images en deux catÃ©gories :

- **OK** : image valide (ex. vÃªtement isolÃ©)  
- **NOK** : image invalide (ex. prÃ©sence dâ€™une personne)

Dans un contexte de contrÃ´le qualitÃ©, les erreurs **NOK â†’ OK** (faux positifs) sont critiques.  
Le projet inclut donc une Ã©tape dâ€™optimisation du seuil de dÃ©cision pour rendre le modÃ¨le plus **conservateur**.

---

## âœ”ï¸ EntraÃ®nement du modÃ¨le

Lâ€™entraÃ®nement repose sur :

- `DataBlock` fastai  
- architecture **ResNet18** prÃ©-entraÃ®nÃ©e (ImageNet)  
- `fine_tune(5)`  
- augmentations lÃ©gÃ¨res  
- dataset Ã©quilibrÃ©  
- mÃ©triques : accuracy, precision, recall, F1

### **Performances sur le jeu de test**

- **Accuracy : ~0.99**  
- **Precision (OK) : 0.996**  
- **Recall (OK) : 0.977**  
- **F1-score (OK) : 0.986**

---

## ğŸšï¸ Optimisation du seuil (Threshold Tuning)

En Ã©valuant des thresholds entre **0.50** et **0.99**, le modÃ¨le montre que :

> **Threshold optimal = 0.99**

Ce seuil minimise fortement les **faux positifs (NOK â†’ OK)** tout en conservant une excellente performance globale.

Le threshold est sauvegardÃ© dans :  
`ok_nok_threshold.json`

---

## ğŸ” InfÃ©rence sur une image

Une fonction dâ€™infÃ©rence personnalisÃ©e applique le threshold afin dâ€™obtenir une prÃ©diction plus robuste :

```python
def predict_image(img_path, threshold=THRESHOLD_OK):
    img = PILImage.create(img_path)
    pred_label, pred_idx, probs = learn.predict(img)

    idx_ok = learn.dls.vocab.o2i["ok"]
    prob_ok = float(probs[idx_ok])

    final_label = "ok" if prob_ok >= threshold else "nok"

    display(img.to_thumb(256, 256))
    print(f"ProbabilitÃ© 'ok' = {prob_ok:.4f}")
    print(f"Seuil utilisÃ©     = {threshold:.2f}")
    print(f"PrÃ©diction brute  = {pred_label}")
    print(f"PrÃ©diction finale = {final_label}")

    return final_label, prob_ok
````

Usage :

```python
predict_image("path/to/image.jpg")
```

---

## ğŸ’¾ Export du modÃ¨le

```python
learn.export("ok_nok_resnet18_fastai.pkl")
```

Sauvegarde du threshold :

```python
json.dump({"threshold_ok": 0.99}, open("ok_nok_threshold.json", "w"))
```

---

## ğŸ”§ Installation

```bash
conda create -n oknok python=3.10
conda activate oknok
pip install fastai torch torchvision
```

Datasets Ã  placer dans :

```
dataset/
    train/
    val/
    test/
```

---

## ğŸ§ª AmÃ©liorations possibles

* essayer ResNet34 / ResNet50
* ajouter des â€œhard negativesâ€ pour renforcer la robustesse
* augmenter les donnÃ©es (augmentation plus forte)
* packager une API (FastAPI)
* script CLI dâ€™infÃ©rence

---

## ğŸ“œ Licence

Ce projet est distribuÃ© sous licence **MIT**.
Voir le fichier [`LICENSE`](LICENSE).